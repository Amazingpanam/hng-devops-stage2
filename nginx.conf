worker_processes 1;

events {
    worker_connections 1024;
}

http {
    upstream blue {
        server app_blue:8081;
    }

    upstream green {
        server app_green:8082;
    }

    server {
        listen 8080;

        location / {
            # Use the active pool
            set $active_pool ${ACTIVE_POOL};
            if ($active_pool = blue) {
                proxy_pass http://blue;
            }

            if ($active_pool = green) {
                proxy_pass http://green;
            }

            # Health check
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Forward headers
            proxy_set_header X-App-Pool $active_pool;
            proxy_set_header X-Release-Id $http_x_release_id;

            # Timeout settings
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
            proxy_send_timeout 5s;

            # Retry on failure
            error_page 502 = @fallback;
        }

        location @fallback {
            proxy_pass http://green;
            proxy_set_header X-App-Pool green;
            proxy_set_header X-Release-Id $http_x_release_id;
        }

        location /healthz {
            proxy_pass http://blue;
        }

        location /version {
            proxy_pass http://blue;
        }

        location /chaos/start {
            proxy_pass http://blue;
        }

        location /chaos/stop {
            proxy_pass http://blue;
        }
    }
}